# ã‚¬ã‚¹ãƒ¬ã‚¹æ±ºæ¸ˆãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸ï¼ˆPermitç½²åãƒ™ãƒ¼ã‚¹ï¼‰

ERC-2612 Permitæ©Ÿèƒ½ã‚’ä½¿ç”¨ã—ãŸã‚¬ã‚¹ãƒ¬ã‚¹æ±ºæ¸ˆã®å®Ÿè£…ãŒå®Œäº†ã—ã¾ã—ãŸã€‚
Gelato Relayã‚’ä½¿ã‚ãšã€Permitã‚·ã‚°ãƒãƒãƒ£ã§åŠ¹ç‡çš„ã«ã‚¬ã‚¹ãƒ¬ã‚¹æ±ºæ¸ˆã‚’å®Ÿç¾ã—ã¾ã™ã€‚

## ğŸ“± ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸

### 1. QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸
**URL**: `/gasless-qr-test` ã¾ãŸã¯ `/?ui=gasless-qr-test`

**æ©Ÿèƒ½**:
- JPYCæ±ºæ¸ˆç”¨ã®QRã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ
- X402å½¢å¼ã®ãƒšã‚¤ãƒ¡ãƒ³ãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½œæˆ
- `gasless: true` ãƒ•ãƒ©ã‚°ä»˜ãQRã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ
- QRãƒ‡ãƒ¼ã‚¿ã®ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½

**ä½¿ã„æ–¹**:
1. ã‚¦ã‚©ãƒ¬ãƒƒãƒˆã‚’æ¥ç¶š
2. é‡‘é¡ï¼ˆJPYCï¼‰ã‚’å…¥åŠ›
3. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰ã‚’å…¥åŠ›
4. æœ‰åŠ¹æœŸé™ï¼ˆåˆ†ï¼‰ã‚’è¨­å®š
5. ã€ŒQRã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã€ã‚’ã‚¯ãƒªãƒƒã‚¯
6. è¡¨ç¤ºã•ã‚ŒãŸQRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒŠãƒ¼ã§ãƒ†ã‚¹ãƒˆ

### 2. QRã‚¹ã‚­ãƒ£ãƒŠãƒ¼ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸
**URL**: `/gasless-scanner-test` ã¾ãŸã¯ `/?ui=gasless-scanner-test`

**æ©Ÿèƒ½**:
- ã‚¹ãƒãƒ›ã‚«ãƒ¡ãƒ©ã€Webã‚«ãƒ¡ãƒ©ä¸¡å¯¾å¿œã®QRã‚¹ã‚­ãƒ£ãƒŠãƒ¼
- X402å½¢å¼QRã‚³ãƒ¼ãƒ‰ã®èª­ã¿å–ã‚Š
- æœ‰åŠ¹æœŸé™ãƒã‚§ãƒƒã‚¯
- æ®‹é«˜ç¢ºèªï¼ˆJPYCï¼‰
- ã‚¬ã‚¹ãƒ¬ã‚¹æ±ºæ¸ˆãƒ•ãƒ©ã‚°ã®è¡¨ç¤º
- ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã§ã®æ±ºæ¸ˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

**ä½¿ã„æ–¹**:
1. ã‚¦ã‚©ãƒ¬ãƒƒãƒˆã‚’æ¥ç¶š
2. ã€ŒQRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã€ã‚’ã‚¯ãƒªãƒƒã‚¯
3. ã‚«ãƒ¡ãƒ©ã§QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³
4. æ±ºæ¸ˆå†…å®¹ã‚’ç¢ºèª
5. ã€Œâš¡ ã‚¬ã‚¹ãƒ¬ã‚¹æ±ºæ¸ˆã€ãƒœã‚¿ãƒ³ã§ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ

## ğŸ”„ ãƒ†ã‚¹ãƒˆãƒ•ãƒ­ãƒ¼

### åŸºæœ¬çš„ãªãƒ†ã‚¹ãƒˆæ‰‹é †

1. **QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆ**
   - `/gasless-qr-test` ã«ã‚¢ã‚¯ã‚»ã‚¹
   - 100 JPYC ã®QRã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ
   - QRã‚³ãƒ¼ãƒ‰ã‚’è¡¨ç¤º

2. **QRã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³**
   - åˆ¥ã®ãƒ‡ãƒã‚¤ã‚¹ã¾ãŸã¯ã‚¿ãƒ–ã§ `/gasless-scanner-test` ã‚’é–‹ã
   - ã‚¹ã‚­ãƒ£ãƒŠãƒ¼ã§QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã‚Š
   - `gasless: true` ãƒ•ãƒ©ã‚°ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª

3. **æ±ºæ¸ˆãƒ†ã‚¹ãƒˆ**
   - ã‚¹ã‚­ãƒ£ãƒ³å¾Œã€æ±ºæ¸ˆå†…å®¹ã‚’ç¢ºèª
   - ã€Œâš¡ ã‚¬ã‚¹ãƒ¬ã‚¹æ±ºæ¸ˆã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
   - ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª

## ğŸ“‹ ç”Ÿæˆã•ã‚Œã‚‹QRãƒ‡ãƒ¼ã‚¿å½¢å¼

```json
{
  "to": "0x...",              // å—å–ã‚¢ãƒ‰ãƒ¬ã‚¹
  "token": "0xE7C3D8C9...",   // JPYCãƒˆãƒ¼ã‚¯ãƒ³ã‚¢ãƒ‰ãƒ¬ã‚¹
  "amount": "100000000000000000000", // Weiå˜ä½ã®é‡‘é¡
  "chainId": 137,              // Polygon Mainnet
  "expires": 1234567890000,    // æœ‰åŠ¹æœŸé™ï¼ˆUnix timestampï¼‰
  "message": "ã‚³ãƒ¼ãƒ’ãƒ¼ä»£",     // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  "requestId": "gasless_...",  // ãƒªã‚¯ã‚¨ã‚¹ãƒˆID
  "gasless": true              // ã‚¬ã‚¹ãƒ¬ã‚¹æ±ºæ¸ˆãƒ•ãƒ©ã‚°
}
```

## ğŸ¯ å®Ÿè£…å®Œäº†æ¸ˆã¿ã®æ©Ÿèƒ½

### âœ… PaymentGatewayWithPermit ã‚¹ãƒãƒ¼ãƒˆã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆ
- [contracts/PaymentGatewayWithPermit.sol](contracts/PaymentGatewayWithPermit.sol)
- ERC-2612 Permitæ©Ÿèƒ½ã‚’ä½¿ç”¨
- ãƒªãƒ—ãƒ¬ã‚¤ã‚¢ã‚¿ãƒƒã‚¯é˜²æ­¢ï¼ˆrequestIDç®¡ç†ï¼‰
- ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ æ‰‹æ•°æ–™ã‚µãƒãƒ¼ãƒˆ
- Pausableã€ReentrancyGuardå¯¾å¿œ

### âœ… Permitã‚·ã‚°ãƒãƒãƒ£ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
- [src/utils/permitSignature.ts](src/utils/permitSignature.ts)
- EIP-712ç½²åç”Ÿæˆ
- Permitãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æº–å‚™
- ã‚ªãƒ•ãƒã‚§ãƒ¼ãƒ³ç½²åæ¤œè¨¼

### âœ… ã‚¬ã‚¹ãƒ¬ã‚¹ã‚¹ã‚­ãƒ£ãƒŠãƒ¼å®Ÿè£…
- [src/pages/GaslessScannerTest.tsx](src/pages/GaslessScannerTest.tsx)
- Permitã‚·ã‚°ãƒãƒãƒ£ç”Ÿæˆ â†’ PaymentGatewayå‘¼ã³å‡ºã—
- å®Œå…¨ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ®‹é«˜è¡¨ç¤º

## ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †

### 1. PaymentGatewayã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã‚’ãƒ‡ãƒ—ãƒ­ã‚¤

```bash
# Hardhatã§ãƒ‡ãƒ—ãƒ­ã‚¤
npx hardhat run scripts/deploy-payment-gateway.cjs --network polygon

# ã¾ãŸã¯ã€ç’°å¢ƒå¤‰æ•°ã‚’æŒ‡å®šã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤
PLATFORM_FEE_RECIPIENT=0xYourAddress npx hardhat run scripts/deploy-payment-gateway.cjs --network polygon
```

### 2. .envãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›´æ–°

```bash
# ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã®ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’è¨­å®š
VITE_PAYMENT_GATEWAY_ADDRESS=0xDeployedGatewayAddress
```

### 3. ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸ã§å‹•ä½œç¢ºèª

```bash
# é–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•
pnpm dev

# QRç”Ÿæˆãƒšãƒ¼ã‚¸
http://localhost:5173/gasless-qr-test

# ã‚¹ã‚­ãƒ£ãƒŠãƒ¼ãƒšãƒ¼ã‚¸
http://localhost:5173/gasless-scanner-test
```

## ğŸ§ª ãƒ†ã‚¹ãƒˆãƒ•ãƒ­ãƒ¼ï¼ˆå®Œå…¨ç‰ˆï¼‰

1. **QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆ**
   - `/gasless-qr-test` ã«ã‚¢ã‚¯ã‚»ã‚¹
   - ã‚¦ã‚©ãƒ¬ãƒƒãƒˆæ¥ç¶š
   - é‡‘é¡ï¼ˆä¾‹: 100 JPYCï¼‰ã‚’å…¥åŠ›
   - QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
   - `gasless: true` ãƒ•ãƒ©ã‚°ãŒå«ã¾ã‚Œã‚‹

2. **Permitã‚·ã‚°ãƒãƒãƒ£ç”Ÿæˆ**
   - `/gasless-scanner-test` ã§QRã‚¹ã‚­ãƒ£ãƒ³
   - æ±ºæ¸ˆå†…å®¹ç¢ºèª
   - ã€Œâš¡ ã‚¬ã‚¹ãƒ¬ã‚¹æ±ºæ¸ˆã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
   - ã‚¦ã‚©ãƒ¬ãƒƒãƒˆã§Permitç½²åï¼ˆã‚¬ã‚¹ä»£ä¸è¦ï¼‰

3. **PaymentGatewayå‘¼ã³å‡ºã—**
   - PaymentGateway.executePaymentWithPermit()
   - Permitç½²åã§è‡ªå‹•approve
   - JPYCãƒˆãƒ¼ã‚¯ãƒ³è»¢é€
   - ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å®Œäº†

## ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ©Ÿèƒ½

- **ãƒªãƒ—ãƒ¬ã‚¤ã‚¢ã‚¿ãƒƒã‚¯é˜²æ­¢**: requestIDã§é‡è¤‡æ±ºæ¸ˆã‚’é˜²æ­¢
- **æœ‰åŠ¹æœŸé™ãƒã‚§ãƒƒã‚¯**: Permitç½²åã«æœ‰åŠ¹æœŸé™ã‚’è¨­å®š
- **EIP-712ç½²å**: æ¨™æº–åŒ–ã•ã‚ŒãŸç½²åå½¢å¼
- **Pausable**: ç·Šæ€¥åœæ­¢æ©Ÿèƒ½
- **ReentrancyGuard**: å†å…¥æ”»æ’ƒé˜²æ­¢
- **ãƒã‚§ãƒ¼ãƒ³IDæ¤œè¨¼**: æ­£ã—ã„ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã§ã®ã¿å®Ÿè¡Œ

## ğŸ“Š ã‚¬ã‚¹ãƒ¬ã‚¹æ±ºæ¸ˆã®ãƒ¡ãƒªãƒƒãƒˆ

1. **ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“å‘ä¸Š**
   - MATICãŒä¸è¦
   - JPYCæ®‹é«˜ã®ã¿ã§æ±ºæ¸ˆå¯èƒ½

2. **ã‚³ã‚¹ãƒˆå‰Šæ¸›**
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã‚¬ã‚¹ä»£ã‚’æ”¯æ‰•ã‚ãªã„
   - 1ç½²åã§æ±ºæ¸ˆå®Œäº†

3. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**
   - æ¨™æº–åŒ–ã•ã‚ŒãŸERC-2612 Permit
   - ã‚ªãƒ³ãƒã‚§ãƒ¼ãƒ³ã§æ¤œè¨¼å¯èƒ½

## ğŸ”„ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—: æœ¬ç•ªã‚·ã‚¹ãƒ†ãƒ ã¸ã®çµ±åˆ

### Phase 1: X402PaymentSectionã¸ã®çµ±åˆ

æ—¢å­˜ã® [X402PaymentSection.tsx](src/components/X402PaymentSection.tsx) ã«Permitæ±ºæ¸ˆã‚’è¿½åŠ ï¼š

```typescript
// QRã‚³ãƒ¼ãƒ‰ã« gasless: true ãƒ•ãƒ©ã‚°ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
if (paymentData.gasless) {
  // Permitãƒ™ãƒ¼ã‚¹ã®ã‚¬ã‚¹ãƒ¬ã‚¹æ±ºæ¸ˆ
  const permitParams = await preparePermitPaymentParams(...);
  const tx = await gatewayContract.executePaymentWithPermit(...);
} else {
  // é€šå¸¸ã®MetaMaskæ±ºæ¸ˆ
  const tx = await tokenContract.transfer(...);
}
```

### Phase 2: Supabaseé€£æº

æ±ºæ¸ˆå®Œäº†å¾Œã€Supabaseã«è¨˜éŒ²ï¼š

```typescript
await supabase.from('payment_requests').update({
  status: 'completed',
  transaction_hash: tx.hash,
  completed_at: new Date().toISOString(),
});
```

### Phase 3: æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤

1. PaymentGatewayã‚’Polygon Mainnetã«ãƒ‡ãƒ—ãƒ­ã‚¤
2. Polygonscanã§æ¤œè¨¼
3. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚’Vercelã«ãƒ‡ãƒ—ãƒ­ã‚¤

## ğŸ“ ä½œæˆãƒ»æ›´æ–°ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«

### ã‚¹ãƒãƒ¼ãƒˆã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆ
- [contracts/PaymentGatewayWithPermit.sol](contracts/PaymentGatewayWithPermit.sol) - Permitãƒ™ãƒ¼ã‚¹æ±ºæ¸ˆã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤
- [scripts/deploy-payment-gateway.cjs](scripts/deploy-payment-gateway.cjs) - ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰
- [src/pages/GaslessQRGeneratorTest.tsx](src/pages/GaslessQRGeneratorTest.tsx) - QRç”Ÿæˆãƒšãƒ¼ã‚¸
- [src/pages/GaslessScannerTest.tsx](src/pages/GaslessScannerTest.tsx) - ã‚¹ã‚­ãƒ£ãƒŠãƒ¼ãƒšãƒ¼ã‚¸ï¼ˆPermitå®Ÿè£…æ¸ˆã¿ï¼‰
- [src/utils/permitSignature.ts](src/utils/permitSignature.ts) - Permitã‚·ã‚°ãƒãƒãƒ£ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
- [src/main.tsx](src/main.tsx) - ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¨­å®šï¼ˆæ›´æ–°ï¼‰

## ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã®ã‚¢ã‚¯ã‚»ã‚¹

ãƒ“ãƒ«ãƒ‰ã¨ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã€ä»¥ä¸‹ã®URLã§ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ï¼š

- QRç”Ÿæˆ: `https://your-domain.com/gasless-qr-test`
- ã‚¹ã‚­ãƒ£ãƒŠãƒ¼: `https://your-domain.com/gasless-scanner-test`

## ğŸ’¡ Tips

- **ã‚¹ãƒãƒ›ãƒ†ã‚¹ãƒˆ**: 2å°ã®ã‚¹ãƒãƒ›ã§ã€ç‰‡æ–¹ã§QRç”Ÿæˆã€ã‚‚ã†ç‰‡æ–¹ã§ã‚¹ã‚­ãƒ£ãƒ³
- **PC + ã‚¹ãƒãƒ›ãƒ†ã‚¹ãƒˆ**: PCã§QRè¡¨ç¤ºã€ã‚¹ãƒãƒ›ã§ã‚¹ã‚­ãƒ£ãƒ³
- **ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°**: ã‚¹ã‚­ãƒ£ãƒŠãƒ¼ã«ã¯è©³ç´°ãªãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™
- **æœ‰åŠ¹æœŸé™**: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ30åˆ†ã€ãƒ†ã‚¹ãƒˆæ™‚ã¯çŸ­ãè¨­å®šå¯èƒ½

## ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …

- requestIdã§ãƒªãƒ—ãƒ¬ã‚¤ã‚¢ã‚¿ãƒƒã‚¯é˜²æ­¢
- æœ‰åŠ¹æœŸé™ãƒã‚§ãƒƒã‚¯
- ãƒã‚§ãƒ¼ãƒ³IDæ¤œè¨¼
- ã‚¢ãƒ‰ãƒ¬ã‚¹æ¤œè¨¼ï¼ˆEIP-55ï¼‰
- æ®‹é«˜ç¢ºèª

---

**æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³**: ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸ã§å‹•ä½œç¢ºèªå¾Œã€ã‚¬ã‚¹ãƒ¬ã‚¹æ±ºæ¸ˆã®æœ¬å®Ÿè£…ã«é€²ã‚“ã§ãã ã•ã„ã€‚
