<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QRã‚¹ã‚­ãƒ£ãƒŠãƒ¼ãƒ†ã‚¹ãƒˆ</title>
  <!-- é‡è¦: æœ¬ç•ªç’°å¢ƒã¨å…¨ãåŒã˜ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä½¿ç”¨ -->
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      max-width: 600px;
      margin: 0 auto;
    }
    #reader {
      width: 100%;
      max-width: 500px;
      margin: 20px auto;
    }
    .log {
      background: #f0f0f0;
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
    }
    .success { color: green; }
    .error { color: red; }
    .info { color: blue; }
  </style>
</head>
<body>
  <h1>ğŸ” QRã‚¹ã‚­ãƒ£ãƒŠãƒ¼ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«</h1>

  <div>
    <h2>ãƒ†ã‚¹ãƒˆç”¨QRã‚³ãƒ¼ãƒ‰</h2>
    <p>ã“ã®QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„ï¼š</p>

    <div style="margin-bottom: 20px;">
      <label for="qr-format-select">QRå½¢å¼ã‚’é¸æŠ:</label>
      <select id="qr-format-select" onchange="generateSelectedQR()" style="margin-left: 10px; padding: 5px;">
        <option value="ethereum-uri">ethereum: URI (æ¨å¥¨)</option>
        <option value="json">JSONå½¢å¼</option>
        <option value="simple-address">ã‚·ãƒ³ãƒ—ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</option>
      </select>
    </div>

    <div style="background: white; padding: 20px; display: inline-block; border-radius: 8px;">
      <canvas id="qr-canvas"></canvas>
    </div>
    <p><strong>ãƒ‡ãƒ¼ã‚¿:</strong> <code id="qr-data">ethereum:0x66F1274aD5d042b7571C2EfA943370dbcd3459aB@137</code></p>
    <p><strong>ãƒ‡ãƒ¼ã‚¿é•·:</strong> <code id="qr-length">55</code> æ–‡å­—</p>
  </div>

  <hr>

  <h2>ã‚¹ã‚­ãƒ£ãƒŠãƒ¼</h2>
  <button onclick="startScanner()" id="start-btn">ğŸ“· ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹</button>
  <button onclick="stopScanner()" id="stop-btn" disabled>â¹ï¸ ã‚¹ã‚­ãƒ£ãƒ³åœæ­¢</button>

  <div id="reader"></div>

  <h2>ãƒ­ã‚°</h2>
  <div class="log" id="log"></div>

  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <script>
    const logDiv = document.getElementById('log');
    let html5QrCode = null;

    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = document.createElement('div');
      logEntry.className = type;
      logEntry.textContent = `[${timestamp}] ${message}`;
      logDiv.insertBefore(logEntry, logDiv.firstChild);
      console.log(`[${type}] ${message}`);
    }

    // ãƒ†ã‚¹ãƒˆç”¨QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
    let qrData = 'ethereum:0x66F1274aD5d042b7571C2EfA943370dbcd3459aB@137';
    const canvas = document.getElementById('qr-canvas');

    function generateSelectedQR() {
      const format = document.getElementById('qr-format-select').value;

      switch(format) {
        case 'ethereum-uri':
          qrData = 'ethereum:0x66F1274aD5d042b7571C2EfA943370dbcd3459aB@137';
          break;
        case 'json':
          qrData = JSON.stringify({
            type: 'wallet',
            address: '0x66F1274aD5d042b7571C2EfA943370dbcd3459aB',
            chainId: 137,
            name: 'ãƒ†ã‚¹ãƒˆåº—èˆ—'
          });
          break;
        case 'simple-address':
          qrData = '0x66F1274aD5d042b7571C2EfA943370dbcd3459aB';
          break;
      }

      document.getElementById('qr-data').textContent = qrData;
      document.getElementById('qr-length').textContent = qrData.length;

      QRCode.toCanvas(canvas, qrData, {
        width: 200,
        errorCorrectionLevel: 'H',
        margin: 2
      }, (error) => {
        if (error) {
          log('QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆã‚¨ãƒ©ãƒ¼: ' + error, 'error');
        } else {
          log('QRã‚³ãƒ¼ãƒ‰ç”ŸæˆæˆåŠŸ (' + format + 'å½¢å¼): ' + qrData.length + 'æ–‡å­—', 'success');
        }
      });
    }

    // åˆæœŸQRç”Ÿæˆ
    generateSelectedQR();

    async function startScanner() {
      try {
        log('ã‚¹ã‚­ãƒ£ãƒŠãƒ¼åˆæœŸåŒ–é–‹å§‹...', 'info');

        if (!html5QrCode) {
          html5QrCode = new Html5Qrcode('reader');
          log('Html5Qrcode ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆå®Œäº†', 'info');
        }

        // æœ¬ç•ªç’°å¢ƒã¨å®Œå…¨ã«åŒä¸€ã®è¨­å®š
        const config = {
          fps: 10,
          qrbox: { width: 250, height: 250 },
          aspectRatio: 1.0,
          disableFlip: false
        };

        log('è¨­å®š: ' + JSON.stringify(config), 'info');
        log('ã‚«ãƒ¡ãƒ©èµ·å‹•ä¸­...', 'info');

        // ãƒ‡ãƒã‚¤ã‚¹ã‚«ãƒ¡ãƒ©ã®ç¢ºèª
        try {
          const devices = await Html5Qrcode.getCameras();
          log('åˆ©ç”¨å¯èƒ½ãªã‚«ãƒ¡ãƒ©æ•°: ' + devices.length, 'info');
          devices.forEach((device, idx) => {
            log(`ã‚«ãƒ¡ãƒ©${idx}: ${device.label || device.id}`, 'info');
          });
        } catch (e) {
          log('ã‚«ãƒ¡ãƒ©åˆ—æŒ™ã‚¨ãƒ©ãƒ¼: ' + e.message, 'error');
        }

        await html5QrCode.start(
          { facingMode: 'environment' },
          config,
          (decodedText, decodedResult) => {
            log('âœ… QRã‚³ãƒ¼ãƒ‰èª­ã¿å–ã‚ŠæˆåŠŸ!', 'success');
            log('ãƒ‡ãƒ¼ã‚¿é•·: ' + decodedText.length + ' æ–‡å­—', 'info');
            log('ãƒ‡ãƒ¼ã‚¿: ' + decodedText, 'success');
            log('å½¢å¼: ' + decodedResult.result.format.formatName, 'info');
            log('å®Œå…¨ãªãƒ‡ã‚³ãƒ¼ãƒ‰çµæœ: ' + JSON.stringify(decodedResult.result), 'info');

            // ãƒ†ã‚¹ãƒˆQRã¨ä¸€è‡´ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            if (decodedText === qrData) {
              log('ğŸ‰ ãƒ†ã‚¹ãƒˆQRã‚³ãƒ¼ãƒ‰ã¨å®Œå…¨ä¸€è‡´!', 'success');
            } else {
              log('âš ï¸ ãƒ†ã‚¹ãƒˆQRã‚³ãƒ¼ãƒ‰ã¨ä¸ä¸€è‡´', 'error');
              log('æœŸå¾…å€¤: ' + qrData, 'error');
              log('å®Ÿéš›å€¤: ' + decodedText, 'error');
            }
          },
          (errorMessage) => {
            // å…¨ã¦ã®ã‚¨ãƒ©ãƒ¼ã‚’ãƒ­ã‚°å‡ºåŠ›ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
            if (errorMessage) {
              // é »ç¹ã™ãã‚‹ã‚¨ãƒ©ãƒ¼ã¯10å›ã«1å›ã ã‘ãƒ­ã‚°
              if (!errorMessage.includes('No MultiFormat Readers') || Math.random() < 0.1) {
                log('ã‚¹ã‚­ãƒ£ãƒ³ã‚¨ãƒ©ãƒ¼: ' + errorMessage, 'error');
              }
            }
          }
        );

        log('ã‚«ãƒ¡ãƒ©èµ·å‹•æˆåŠŸ', 'success');
        document.getElementById('start-btn').disabled = true;
        document.getElementById('stop-btn').disabled = false;

      } catch (err) {
        log('âŒ ã‚«ãƒ¡ãƒ©èµ·å‹•å¤±æ•—: ' + err.message, 'error');
        log('ã‚¨ãƒ©ãƒ¼å: ' + err.name, 'error');
        log('ã‚¨ãƒ©ãƒ¼ã‚¹ã‚¿ãƒƒã‚¯: ' + (err.stack || 'ãªã—'), 'error');
        log('è©³ç´°: ' + JSON.stringify(err), 'error');

        // ã‚ˆãã‚ã‚‹ã‚¨ãƒ©ãƒ¼ã®è¨ºæ–­
        if (err.name === 'NotAllowedError') {
          log('ğŸ’¡ è¨ºæ–­: ã‚«ãƒ¡ãƒ©ã®æ¨©é™ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 'error');
        } else if (err.name === 'NotFoundError') {
          log('ğŸ’¡ è¨ºæ–­: ã‚«ãƒ¡ãƒ©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ‡ãƒã‚¤ã‚¹ã«ã‚«ãƒ¡ãƒ©ãŒã‚ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 'error');
        } else if (err.name === 'NotReadableError') {
          log('ğŸ’¡ è¨ºæ–­: ã‚«ãƒ¡ãƒ©ã¯è¦‹ã¤ã‹ã‚Šã¾ã—ãŸãŒä½¿ç”¨ã§ãã¾ã›ã‚“ã€‚ä»–ã®ã‚¢ãƒ—ãƒªãŒã‚«ãƒ¡ãƒ©ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚', 'error');
        }
      }
    }

    async function stopScanner() {
      try {
        if (html5QrCode) {
          await html5QrCode.stop();
          log('ã‚¹ã‚­ãƒ£ãƒŠãƒ¼åœæ­¢', 'info');
          document.getElementById('start-btn').disabled = false;
          document.getElementById('stop-btn').disabled = true;
        }
      } catch (err) {
        log('åœæ­¢ã‚¨ãƒ©ãƒ¼: ' + err.message, 'error');
      }
    }

    // ãƒ–ãƒ©ã‚¦ã‚¶æƒ…å ±ã‚’ãƒ­ã‚°
    log('User Agent: ' + navigator.userAgent, 'info');
    log('Platform: ' + navigator.platform, 'info');
    log('Screen: ' + window.screen.width + 'x' + window.screen.height, 'info');
  </script>
</body>
</html>
